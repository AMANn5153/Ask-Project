const express=require("express")
const mongoose=require("mongoose")
const router =express.Router()
const bcrypt=require("bcryptjs")
const {Testbackend,Comment}=require("../models/models")
const {Token}=require("../models/token.model")
const authenticate=require("../middleware/authenticate")
const multer = require("multer")
const path=require("path")
const {passChange}=require("../mailer/emailPassChange")
const { resolve } = require("path")
const crypto=require("crypto")



const storage=multer.diskStorage({
  destination:function(req,file,cb){
    cb(null,'./profile_pic')
  },
  filename:function(req,file,cb){
    cb(null,file.originalname)
  }
})

const storageCodeSnip=multer.diskStorage({
  destination:function(req,file,cb){
    cb(null,"./code_snip")
  },
  filename:function(req,file,cb){
    cb(null,file.originalname)
  }
})

  const fileFilter=(req,file,cb)=>{
    if(file.mimetype=="image/jpeg" || file.mimetype=="image/png"){
      cb(null,true)
    }else{
      cb(new Error("file type is wrong try .jpg or .png extension"),false)
    }
  }

const upload=multer(
  {
  storage:storage,
  limits:{
    fileSize:1024*1024 //limiting the file size
  },
  fileFilter:fileFilter //filtering the file with only jpeg and png photo
  } ,
)

const uploadCode=multer(
  {
    storage:storageCodeSnip,
    limits:{
      fileSize:1024*1024
    },
    fileFilter:fileFilter
  }
)



router.post("/register",async (req,res)=>{      //registeration  API
    const  {username,email,password}=req.body;
    if(!username||!email||!password){
      return  res.status(403).json({error:"empty field"})
    }
    try{
        const exist=await Testbackend.findOne({email:email})
        if(exist){
           return res.status(409).json({error:"user alerady exist"})
        }
        else{
        const backend=new Testbackend({username,email,password})
        const result=await backend.save();
        if(result){
          return  res.status(201).json({message:" user is created"})
        }
      }
    }
    catch(e){
        res.status(499).json({error:e})
    }
})

router.post("/Login",async (req,res)=>{       //Login  API
    
  const {email,Password}=req.body;
  console.log(req.body)
  if(!email || !Password){
   return res.status(403).json({error:"empty Fields"})
  }

  try{
    const exist=await Testbackend.findOne({email})
    if(exist){
      const passCheck=await bcrypt.compare(Password,exist.password)
      if(passCheck){
        const token= await exist.generateAuthToken();
        console.log(token)
        res.cookie("authcookie",token,{
          expires:new Date(Date.now()+36000000),
          httpOnly:false,
        }) 
        res.status(200).json({token:token})                                                                                        
      }
      else{
        return res.status(401).json({error:"invalid credentials"})
      }
    }
    else{
      return res.status(401).json({error:"invalid credentials"})
}}catch(e){
  console.log(e)
  res.status(500).json({error:"wont be able to login"})
}}
)
router.get("/CheckLogin",authenticate,async(req,res)=>{
  const token=req.token
  try{
    if(token){
      res.status(200).json({message:true})
    }
    else{
      res.json({message:false})
    }
  }
  catch(e){
    res.status(500).json({error:"some errror occured"})
    console.log(e)
  }
})

router.post("/emailVerify",async(req,res)=>{
  req.to=req.body.data;
  try{
    const userExist=await Testbackend.findOne({email:req.body.data})
      if(userExist){
        req.name=userExist.username// putting username in req object 
        // creating a token for password reset 
        const token=crypto.randomBytes(32).toString("hex")
        req.passToken=token
        // hashing the token
        const hashToken=await bcrypt.hash(token,10)
        //finding if token exist in the database
        const tokenExist=await Token.findOne({userId:userExist._id})
        //if exist then delete that token because new request for the reset password has been send
        if(tokenExist){
          await tokenExist.deleteOne()
        }
          //saving the newly created token
          const setToken=await new Token({
            userId:userExist._id,
            token:hashToken,
          }).save()
       
        passChange(req)
        res.status(200).json({"message":"check your Email"})}
       else{
        res.status(401).send("User Not Found!")
      }
  }
  catch(e){
    console.log(e)
    res.status(500).send("error occured")
   
  }
})

// change pass  pass word changing

router.put("/changePass",async(req,res)=>{
  try{
  //destructuring the data in req.body
  const {password,token,email}=req.body
  //checking email in the database if there is move on or send a response with 404 error user not found
  const checkEmail=await Testbackend.findOne({email:email})
  if(checkEmail){
    //finding the token if it dosen't exist it means TTL has deleted the token ,
    // sending the res with token has been expired
    const findToken=await Token.findOne({userId:checkEmail._id})
    if(!findToken){
      res.status(404).json({"message":"token was expired try again"})
    }else{
      //if token exist in the collection then just compare the token that came from the frontend and database
    const checkToken=await bcrypt.compare(token,findToken.token)
    if(checkToken){
      const hashPassword=await bcrypt.hash(password,12)
      //if token has been found then update the database with new password and send response as password change
      const changePassword=await Testbackend.findOneAndUpdate({id:checkEmail._id},{$set:{password:hashPassword}})
      const savePassword=await changePassword.save();
      if(savePassword){
        await findToken.deleteOne()
        res.status(200).json({"message":"password Changed"})
      }
    }
    else{
      // if token dosen't match then send response you're not authorized
      res.status(403).json({"message":"you're not authorized"})
    }
  }
  }
  else{
    res.status(404).json({"message":"user not found"})
  }
}
catch(e){
  console.log(e)
  res.status(500).send("some error has occured")
}
})

router.post("/UserInfo",async (req,res)=>{     //userINFO API
  const {id}=req.body
  console.log(req);
  
    try{
      const result=await Testbackend.findOne({_id:id},"username")
      
      res.status(200).send(result)
    }
    catch(e){
      console.log(e)
      res.status(499).json({error:"internal error"})
    }
})


router.get("/Logout",(req,res)=>{             //Logout API
  res.clearCookie("authcookie") //clears the cookies 
   res.status(200).json({message:"logged Out"})

})


router.post("/Ask",authenticate,uploadCode.single("codeSnip"),async (req,res)=>{ // Posts Question
  
  const id= req.userId
  const {title,problem,problemExpec}=req.body
  let code_snip_path
  if(req.file!=undefined){
   code_snip_path=path.join(__dirname,"../",req.file.path)
  }

  try{
      const findUser=await Testbackend.findOne({"_id":id})
      const indx=findUser.Post.length

      if(!findUser){
          res.status(404).json({error:"user not found"})
      }
      else{
        const postInsertion=await Testbackend.findOneAndUpdate({_id:id},{$push:{Post:[{"title":title,"problem":problem,
        "problemExpec":problemExpec,"codeSnip":code_snip_path,"Likes":[]}]}})
        const result=await postInsertion.save()
        if(!result){
          res.send(304).json({error:"some error occured while Posting the Question"})
        }

        const postFind=await Testbackend.find({_id:id}).select("Post")

        const insertComment= new Comment({userId:id,Postid:postFind[0].Post[indx]._id})//creating a document in Comment to store Question Comments
        const insertresult=await insertComment.save();
        
        if(result&&insertresult){
          res.status(200).json({message:"Question posted"})
        }
      }
  }
  catch(e){
    console.log(e)
    res.status(500).send("error occured")
  }
})



router.get("/api/questionDetails",async (req,res)=>{
  try{
  const questionResult=await Testbackend.aggregate([{
    $project:{"Post":1,"username":1}},{$unwind:"$Post"},{$group:{_id:"$Post._id",title:{$first:"$Post.title"},
    problem:{$first:"$Post.problem"},userId:{$first:"$_id"},date:{$first:"$Post.Date"},username:{$last:"$username"}}}
  ])

  res.status(202).send(questionResult)
  }
  catch(e){
    console.log(e)
    res.status(500).send(e)
  }
})


router.post("/QuestionInfo",async(req,res)=>{//fetchDetails for the  question eith left join comments collection
  const {id}=req.body
  const postId=mongoose.Types.ObjectId(id)
 
  try{
    //first project all the post  with username and then in second operator we're unwinding the post array
    //now we're matching "postId" and the then doing the left join of comment collection
  const detail=await Testbackend.aggregate([{$project:{"Post":1,_id:0,username:1}},{$unwind:"$Post"},//left join 
  {$match:{"Post._id":postId}},{$lookup:{
    from:"comments",
    localField:"Post._id",
    foreignField:"Postid",
    as:"Comment"
    }}
  ])
  
    if(detail){
      
      res.status(200).json(detail)
    }
  }
  catch(e){
    res.status(500).send("some error occured")
    console.log(e)
  }
})

router.post("/getCodeSnip",async(req,res)=>{
  const {id}=req.body
  const postId=mongoose.Types.ObjectId(id)
  try{
    const getCodeSnip=await Testbackend.aggregate([
      {$project:{"Post":1}},
      {$unwind:"$Post"},
      {$match:{"Post._id":postId}},
      {$group:{_id:"$Post.codeSnip"}}
    ])
  
    res.status(200).sendFile(path.resolve(getCodeSnip[0]?._id))
  }
  catch(e){
    res.status(500).send("some error occured")
    console.log(e)
  }
})

router.post("/checkUser",authenticate,async(req,res)=>{
  const {data}=req.body
  let user=req.userId
  try{
    if(data.state.userId==user){
      res.status(499).json({val:true})
    }
    else{
    const checkLikes=await Testbackend.count({"Post._id":data.state.id,"Post.Likes":{$in:[user]}})
      if(checkLikes){
        res.status(499).json({val:true})
      }
    }
  }
  catch(e){
    console.log(e)
    res.status(500).send(e)
  }} )

router.post("/PostLike",authenticate,async(req,res)=>{

  const {id,Postid}=req.body
  let user=req.userId
  try{
    //checking wether user and question exists in the database
      const findQues=await Testbackend.find({"_id":id,"Post._id":Postid})
      if(!findQues){
        res.status(404).json({error:"Question Was Not Found"})
      }
      else{
      const postLike=await Testbackend.findOneAndUpdate({"_id":id,"Post._id":Postid},
      {$push:{"Post.$.Likes":user}},//whoever is looged in  we're fetching the user id of that
      // user and push it into the array of likes field
      {new:true})
       await postLike.save();
      res.status(200).send("liked Post")   
      }
  }  
  catch(e){
    console.log(e)
    res.status(500).json({error:"some error occured in server"})
  }
})

router.post("/getLikes",async(req,res)=>{//getting all the Like  in the document
  const {data}=req.body
  
  try{
    //data.state.userId: it is user id 
    //data.state.id:it is post did that user has made 
    //selecting only Likes field in the document " $ is postional opertaor "
    const LikeArray=await Testbackend.find({"_id":data.userId,"Post._id":data.id})
    .select("Post.Likes.$")
    res.status(200).send(LikeArray)   
    }  
catch(e){
  console.log(e)
  res.status(500).json({error:"some error occured in server"})
}  
  
})


router.put("/Comment",authenticate,async (req,res)=>{
  const {_id}=req.userinfo[0]._id;//fetching the loggedin user from the autheticate middleware
  const {userId,postId,comment}=req.body;//getting data from the frontend
  try{
    const findUser=await Testbackend.findOne({_id})//if user exist
    if(!findUser){
      res.status(400).json({error:"please Login first to reply"})//sending error message if user not found
    }else{


      const postingComment=await Comment.findOneAndUpdate({userId,Postid:postId},
      {$push:{comment:[{commenterid:_id,comment:comment}]}},{new:true})
      //finding and updating comment document with corresponing user and quesindex      
      const postResult=await postingComment.save();///save the result to the document

      if(postResult){
        res.status(200).json({message:"comment posted"});
      }
      else{
        res.status(409).json({error:"failed to post the comment"})
      }
    }
  }
  catch(e){
    console.log(e)
    res.status(500).json({error:"some error occurred in the server",e})
  }
})

 router.post("/ShowComment",async (req,res)=>{
  try{
    const {id,Postid}=req.body;

    const findComment=await Comment.findOne({userId:id,Postid:Postid});
    res.status(200).send(findComment)
  }
  catch(e){
    console.log(e)
    res.status(500).json({error:"server error"})
  }
 })

router.put("/PostReply",authenticate,async(req,res)=>{
  try{
      const {commentId,message}=req.body
      const {_id}=req.userinfo[0]._id;
      
      const updateReply= await  Comment.findOneAndUpdate({"comment._id":commentId},
      {$push:{"comment.$.reply":[{replyId:_id,message:message.Reply}]}},
      {new:true})
      const saveReply=await updateReply.save()
      if(saveReply){
        res.status(202).json({message:"Your Reply Posted"})
      }
    }
  catch(e){
    console.log(e)
    res.status(500).send(e)
  }
})

router.post("/ShowReply",async(req,res)=>{
  const {id}=req.body
  try{
    const showReply=await Comment.findOne({"comment._id":id}).select("comment.reply.$")
    res.status(202).send(showReply)
  }
  catch(e){
    console.log(e)
    res.status(500).send(e)
  }
})

router.get("/Account",authenticate,async(req,res)=>{//this is used for the infomation in the account
  console.log(req)
  try{
    const getUser=await Testbackend.findOne({_id:req.userinfo},{tokens:0})
    res.status(202).send(getUser)
  }
  catch(e){
    console.log(e)
  }
})

router.get("/stats",authenticate,async(req,res)=>{ //route will get stats 
  const id=req.userId
  try{

    //getting all the total number of comment for particular question
    //after sending to the client it calcultes all the total number of comments
    const getStatsComments=await Comment.aggregate([{$match:{comment:{$elemMatch:{commenterid:id}}}},
      {$project:{userId:0,Postid:0}},
      {$group:{_id:"$comment",total:{$sum:{$size:"$comment"}}}}])//using aggregation pipeline for extracting useful data
    
    //getting all the Likes from that the user got on the question 

    const getStatsLikes=await Testbackend.aggregate([{$match:{_id:id}},
      {$project:{Post:1}},
      {$unwind:"$Post"},
      {$project:{"Post.Likes":1,_id:0}},
      {$unwind:"$Post.Likes"}   
    ])

    const getStatsPosts=await Testbackend.aggregate([{$match:{_id:id}},
      {$project:{Post:1}},
      {$group:{_id:"$Post",total:{$sum:{$size:"$Post"}}}}])

      
      if(getStatsComments||getStatsLikes||getStatsPosts){
        res.status(200).send({getStatsLikes:getStatsLikes,
          getStatsComments:getStatsComments
          ,getStatsPosts:getStatsPosts})
      }
    }

  catch(e){
    console.log(e)
    res.status(500).json({error:"some error occured"})
  }
})

router.put("/upload",authenticate,upload.single("pic"),async(req,res)=>{

 const path_profilePic=path.join(__dirname,"../",req.file.path)
 try{
    const uploadProfile=await Testbackend.findOneAndUpdate({_id:req.userinfo[0]._id},{$set:{profilePic:path_profilePic}},{new:true})
    const saveProfilePic=await uploadProfile.save();
    if(saveProfilePic){
      console.log(saveProfilePic)
      res.status(202).sendFile(path.resolve(saveProfilePic.profilePic))
    }
 }
 catch(e){
    console.log(e);
    res.status(500).send("some error occured")
 }
})

router.get("/getPic",authenticate,async(req,res)=>{// ge
  try{
    const proPic=await Testbackend.findOne({_id:req.userId}).select("profilePic")
    if(proPic){
      res.status(202).sendFile(path.resolve(proPic.profilePic))
    }

  }
  catch(e){
    console.log(e)
    res.status(500).send("error occured")
  }
})
router.put("/AddInfo",authenticate,async(req,res)=>{
  const _id=req.userId
  const {data}=req.body
  try{
    const addInfo=await Testbackend.findOneAndUpdate({_id:_id},{$set:{mobile:data.mobile,profession:data.profession,
    company:data.company,college:data.college
    }},{new:true})
    const saveData=await addInfo.save()
    if(saveData){
      res.status(200).json({message:"saved successfully"})
    }
  }
  catch(e){
    res.status(500).send("some error occured")
    console.log(e)
  }
})
router.put("/updateAbout",authenticate,async(req,res)=>{
  const {about}=req.body
  try{
    const updatedAccount=await Testbackend.findOneAndUpdate({_id:req.userId},{$set:{About:about}})
    const saveData=await updatedAccount.save();
    if(saveData){
      res.status(201).json({message:"saved"})
    }
  }
  catch(e){
    console.log(e)
    res.status(500).send("error occured")
  }
})
router.put("/EditProfile",authenticate,async(req,res)=>{
  const id=req.userId
  const {data}=req.body
  try{
    const editProfile=await  Testbackend.findOneAndUpdate({_id:id},{username:data.username,email:data.email,
    company:data.company,college:data.college,mobile:data.college,profession:data.profession
    })

    const saveData=await editProfile.save()

    if(saveData){
      res.status(200).send("saved")
    }
  }
  catch(e){
   res.status(500).json({error:"some error occured"})
   console.log(e)
  }
})

router.put("/delQuestion",authenticate,async(req,res)=>{// deletes the question by taking the spcfic _id
  const id=req.userId
  const {idQues}=req.body
  try{
    const delQues=await Testbackend.findOneAndUpdate({_id:id},{$pull:{Post:{_id:idQues}}},{new:true})//here 
    //findOneAndUpdate pull the subdocument from the specified document _id the pull operator is used for the operation
  }
  catch(e){
    console.log(e)
    res.status(500).send("error Occured")
  }
})
module.exports=router




























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































